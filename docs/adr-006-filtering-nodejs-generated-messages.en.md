# ADR-006: Filtering Node.js Generated Assertion Messages

## Status

Accepted

## Context

Starting with Node.js v24.9.0, the `node:test` runner began appending additional diagnostic information to assertion error messages. When an assertion fails, the test runner now adds the following message:

```
The expression evaluated to a falsy value:

  apply(this.#receiver, actualArgs)
```

This message reveals internal implementation details (`apply(this.#receiver, actualArgs)`) that are:

1. **Redundant**: power-assert already provides detailed, step-by-step evaluation of expressions
2. **Confusing**: The internal method call representation is meaningless to end users
3. **Inappropriate**: Exposes implementation details that should remain hidden from users
4. **Inconsistent**: Only appears in Node.js v24.9.0+, breaking test expectations

The issue affects all power-assert integration tests that verify assertion error message formats, causing 11+ test failures across multiple packages.

## Decision Drivers

* **User Experience**: Assertion messages should be clear, relevant, and free from internal implementation details
* **Information Quality**: power-assert's detailed diagnostics are more valuable than generic messages
* **Backward Compatibility**: Solution should work across Node.js versions
* **Forward Compatibility**: Should handle potential future changes in Node.js error messages
* **Maintainability**: Implementation should be simple and robust

## Considered Options

### Option 1: Keep All Messages (Status Quo)

Continue including all messages from Node.js, including the generated ones.

**Pros:**
- No code changes required
- Preserves all information from Node.js

**Cons:**
- Clutters assertion output with irrelevant internal details
- Confuses users with implementation-specific information
- Tests fail due to unexpected content in assertions
- Violates power-assert's principle of providing clean, focused diagnostics

### Option 2: Filter by `generatedMessage` Flag (Recommended)

Check the AssertionError's `generatedMessage` property to determine if the message was auto-generated by Node.js. Discard generated messages while preserving user-written ones.

```typescript
const isOriginalMessageGenerated = e.generatedMessage;
// ...
if (!isOriginalMessageGenerated) {
  // Keep user-written messages
  newMessageFragments.push(originalMessage);
} else {
  // Discard generated messages
}
```

**Pros:**
- Uses the official API designed for this purpose
- Differentiates between user-written and auto-generated messages
- Works across Node.js versions (flag exists since Node.js v14)
- Preserves important user-written messages
- Robust against future changes in message format
- Aligns with Node.js design intent for the flag

**Cons:**
- Requires checking an additional property
- Minimal code complexity increase

### Option 3: Pattern Matching with Regular Expressions

Use regular expressions to detect and remove the specific unwanted text pattern.

```typescript
const unwantedPattern = /\n\nThe expression evaluated to a falsy value:\n\n  apply\(this\.#receiver, actualArgs\)\n/;
message = message.replace(unwantedPattern, '');
```

**Pros:**
- Direct approach to removing specific text
- No dependency on Node.js internals

**Cons:**
- Brittle: breaks if Node.js changes the exact wording
- May accidentally remove similar user-written text
- Requires maintenance when Node.js updates
- Not semantic - doesn't understand the intent
- Could have false positives

### Option 4: Node.js Version Detection

Check Node.js version and apply different logic for v24.9.0+.

```typescript
if (process.version >= 'v24.9.0') {
  // Apply filtering logic
}
```

**Pros:**
- Explicitly handles version-specific behavior

**Cons:**
- Creates version-dependent code paths
- Requires updates for each Node.js version change
- Doesn't handle backports or patches
- Fragile maintenance burden
- Doesn't solve the root issue semantically

## Decision

We will implement **Option 2: Filter by `generatedMessage` Flag**.

The implementation will:

1. **Check the flag on original errors**: Inspect `AssertionError.generatedMessage` to determine if the original message was auto-generated
2. **Discard generated messages**: When `generatedMessage === true`, skip appending the original message since power-assert provides superior diagnostics
3. **Preserve user messages**: When `generatedMessage === false`, keep the user-written assertion message for non-BinaryExpression assertions
4. **Mark power-assert messages as generated**: Set `generatedMessage: true` on new AssertionErrors created by power-assert since they are programmatically generated

This approach leverages Node.js's official mechanism for distinguishing auto-generated from user-written messages, making it robust and semantically correct.

## Consequences

### Positive

- **Cleaner output**: Users see only relevant, power-assert-generated diagnostics
- **Better user experience**: No confusion from internal implementation details
- **Version-agnostic**: Works with current and future Node.js versions
- **Semantically correct**: Uses the proper API for message classification
- **Preserves user intent**: User-written messages remain visible
- **Future-proof**: Resistant to changes in Node.js error message formatting

### Negative

- **Minimal complexity**: Adds a conditional check in error handling logic
- **Flag dependency**: Relies on Node.js maintaining the `generatedMessage` API (low risk, as it's been stable since v14)

### Neutral

- **Test updates required**: Integration test expectations need updating to match filtered output
- **Documentation value**: The investigation document captures the problem for future reference

## Implementation Notes

The implementation resides in `@power-assert/runtime`:

**File**: `packages/runtime/src/runtime.mts`

**Key changes**:
```typescript
const originalMessage = e.message;
const isOriginalMessageGenerated = e.generatedMessage;

// ... power-assert message generation ...

if (this.#assertionMetadata.binexp) {
  // For binary expression, show comparison
  // ... binary expression analysis ...
  newMessageFragments.push(`${actual} ${operator} ${expected}`);
  newMessageFragments.push('');
} else if (!isOriginalMessageGenerated) {
  // If user-written, keep original message for non-binary assertions
  newMessageFragments.push(originalMessage);
} else {
  // Discard generated message - power-assert provides better diagnostics
}

// Create new error with generated message flag
newAssertionErrorProps.generatedMessage = true;
```

**Testing**: Updated 15 test expectations in `packages/integration-tests/src/__tests__/integration_test.mts` to reflect the cleaner output.

## References

- Node.js AssertionError documentation: https://nodejs.org/api/assert.html#class-assertassertionerror
- Investigation document: [`docs/investigations/2025-09-30-node-v24.9.0-test-output-changes.en.md`](https://github.com/twada/power-assert-monorepo/blob/main/docs/investigations/2025-09-30-node-v24.9.0-test-output-changes.en.md)
